<?phpnamespace App\ClientBundle\Business\TicketItem;use App\ClientBundle\Business;use App\ClientBundle\Business\Base\BaseGridHandler;use App\ClientBundle\Entity;class GridHandler extends BaseGridHandler{    function buildBaseQuery($query, $baseObject = 'p', $filter)    {        $idTicket = $this->container->get('request')->query->get('id', 0);        $query->select($baseObject)            ->from('AppClientBundle:TicketResponse', $baseObject)            ->andWhere($baseObject . '.idTicket = :idTicket')            ->setParameter('idTicket', $idTicket);    }    public function postParseRow(&$r)    {        $r['attachments'] = '';        $r['body'] = html_entity_decode(stripslashes($r["body"]));        $r['body'] = str_replace("&nbsp;", " ", $r["body"]);        $r['body'] = nl2br($r['body']);        $r['idUser'] = $this->helperMapping->getMappingTitle('staff_list', $r['idUser']);        $r['timestamp'] = $this->helperFormatter->format($r['timestamp'], 'datetime');    }    function postGetResultArray(&$array)    {        $ticketResponseIdList = array(0);        foreach ($array as $row) {            $ticketResponseIdList[] = $row['id'];        }        $query = $this->container->get('doctrine')->getEntityManager()->createQueryBuilder();        $query->select('p')            ->from('AppClientBundle:TicketResponseFile', 'p')            ->andWhere('p.idResponse in (:ticketResponseIdList)')            ->setParameter('ticketResponseIdList', $ticketResponseIdList);        $result = $query->getQuery()->getResult();        $uploadPath = $this->container->getParameter('upload_url');        $attachments = array();        foreach ($result as $row) {            if (!isset($attachments[$row->getIdResponse()])) {                $attachments[$row->getIdResponse()] = array();            }            $fileName = explode('/', $row->getFile());            if (isset($fileName[1])) $fileName = $fileName[1];            $attachments[$row->getIdResponse()][] = '<a href="' . $uploadPath . '/' . $row->getFile() . '">' . $fileName . '</a>';        }        // Set attachment        foreach ($array as $k => $ticketResponse) {            if (isset($attachments[$ticketResponse['id']])) {                $array[$k]['attachments'] = implode(', ', $attachments[$ticketResponse['id']]);            }        }    }}